<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –ò–Ω—Ç–µ—Ä–í–µ–∫—Ç–æ—Ä</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/icons/favicon.ico" sizes="any">
    <script src="https://unpkg.com/inputmask@5/dist/inputmask.min.js"></script>
    <script src="/js/dashboard.js" defer></script>
    <script src="/js/documents.js" defer></script>
    <script src="/js/phone-mask.js" defer></script>
</head>
<body class="dashboard-page">
    <header class="main-header">
        <div class="header-container">
            <a href="/" class="logo">–ò–Ω—Ç–µ—Ä–í–µ–∫—Ç–æ—Ä</a>
            <div class="user-controls">
                <a href="/logout" class="btn-logout btn">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="dashboard-sidebar">
            <nav class="dashboard-nav">
                <a href="#tariff" class="nav-item active" data-section="tariff">üìÑ –ú–æ–π —Ç–∞—Ä–∏—Ñ</a>
                <a href="#balance" class="nav-item" data-section="balance">üí≥ –ë–∞–ª–∞–Ω—Å –∏ –æ–ø–ª–∞—Ç–∞</a>
                <a href="#services" class="nav-item" data-section="services">üõ† –ú–æ–∏ —É—Å–ª—É–≥–∏</a>
                <a href="#support" class="nav-item" data-section="support">üìù –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                <a href="#profile" class="nav-item" data-section="profile">üë§ –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ</a>
                <a href="#documents" class="nav-item" data-section="documents">üßæ –î–æ–∫—É–º–µ–Ω—Ç—ã</a>
            </nav>
        </aside>

        <main class="dashboard-content">
            <section id="tariff" class="dashboard-section active">
                <h2>–ú–æ–π —Ç–∞—Ä–∏—Ñ</h2>                <div class="tariff-info">
                    <div class="tariff-info-header">
                        <h3>{{user.tariff.name}}</h3>
                        <div class="tariff-badge">–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ</div>
                    </div>
                    <div class="tariff-details">
                        <div class="tariff-detail-item">
                            <span class="detail-icon">‚ö°</span>
                            <div class="detail-content">
                                <span class="detail-label">–°–∫–æ—Ä–æ—Å—Ç—å</span>
                                <span class="detail-value">{{user.tariff.speed}} –ú–±–∏—Ç/—Å</span>
                            </div>
                        </div>
                        <div class="tariff-detail-item">
                            <span class="detail-icon">üí∞</span>
                            <div class="detail-content">
                                <span class="detail-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                                <span class="detail-value">{{user.tariff.price}} ‚ÇΩ/–º–µ—Å</span>
                            </div>
                        </div>
                        <div class="tariff-detail-item">
                            <span class="detail-icon">üìÖ</span>
                            <div class="detail-content">
                                <span class="detail-label">–°–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ</span>
                                <span class="detail-value">{{formatDate user.nextPayment}}</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn-change-tariff" onclick="showTariffModal()">
                        <span class="btn-text">–°–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</span>
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </div>
            </section>

            <section id="balance" class="dashboard-section">
                <h2>–ë–∞–ª–∞–Ω—Å –∏ –æ–ø–ª–∞—Ç–∞</h2>
                <div class="balance-info">                
                    <div class="current-balance">
                        <h3>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</h3>
                        <p class="balance-amount">{{user.balance}} ‚ÇΩ</p>
                        <div class="expenses-info">
                            <div class="expense-item">
                                <span class="expense-icon">üì°</span>
                                <div class="expense-details">
                                    <span class="expense-label">–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω</span>
                                    <span class="expense-value">{{user.tariff.price}} ‚ÇΩ/–º–µ—Å</span>
                                </div>
                            </div>
                            {{#if user.services_total}}
                            <div class="expense-item">
                                <span class="expense-icon">‚ö°</span>
                                <div class="expense-details">
                                    <span class="expense-label">–î–æ–ø. —É—Å–ª—É–≥–∏</span>
                                    <span class="expense-value">{{user.services_total}} ‚ÇΩ/–º–µ—Å</span>
                                </div>
                            </div>
                            {{/if}}
                            <div class="expense-total">
                                <span class="total-label">–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥</span>
                                <span class="total-value">{{user.total_expenses}} ‚ÇΩ/–º–µ—Å</span>
                            </div>
                        </div>
                        <button class="btn-submit" onclick="showPaymentModal()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                    </div>                    
                    <div class="autopay-settings">
                        <h3>–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂</h3>
                        <div class="autopay-controls">
                            <label class="switch">
                                <input type="checkbox" {{#if user.autopayEnabled}}checked{{/if}} onchange="toggleAutopay(this)">
                                <span class="slider"></span>
                            </label>
                            <div class="threshold-control">
                                <label>–ü–æ–ø–æ–ª–Ω—è—Ç—å –ø—Ä–∏ –±–∞–ª–∞–Ω—Å–µ –Ω–∏–∂–µ:</label>
                                <div class="threshold-input">                                
                                    <input type="number" id="autopayThreshold" 
                                           value="{{user.autopayThreshold}}"
                                           min="100" max="10000" step="100"
                                           onchange="updateAutopayThreshold(this)"
                                           {{#unless user.autopayEnabled}}disabled{{/unless}}>
                                    <span class="currency">‚ÇΩ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="payment-history">
                        <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h3>
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each payments}}
                                <tr>
                                    <td>{{formatDate this.date}}</td>
                                    <td>{{this.amount}} ‚ÇΩ</td>
                                    <td>{{this.method}}</td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="services" class="dashboard-section">
                <h2>–ú–æ–∏ —É—Å–ª—É–≥–∏</h2>                
                <div class="services-list">                    
                    {{#each services}}
                    <div class="service-item {{#if this.enabled}}enabled{{/if}}">
                        <div class="service-info">
                            <h3>{{this.name}}</h3>
                            <p>{{this.description}}</p>
                            <p class="service-price">{{this.price}} ‚ÇΩ/–º–µ—Å</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" {{#if this.enabled}}checked{{/if}} 
                                   data-service-id="{{this.id}}" onchange="toggleService(this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    {{/each}}
                    {{#if services.length}}
                    <div class="services-total">
                        <span class="total-label">–ò—Ç–æ–≥–æ –∑–∞ –¥–æ–ø. —É—Å–ª—É–≥–∏:</span>
                        <span class="total-value">{{user.services_total}} ‚ÇΩ/–º–µ—Å</span>
                    </div>
                    {{/if}}
                </div>
            </section>

            <section id="support" class="dashboard-section">
                <h2>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
                <div class="support-container">                
                    <div class="new-ticket">
                        <button class="btn-submit" onclick="showTicketModal()">–û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É</button>
                    </div>                    
                    <div class="tickets-history">
                        <h3>–ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π</h3>
                        {{#each tickets}}
                        <div class="ticket-item {{this.status}}">
                            <div class="ticket-header">
                                <div class="ticket-main-info">
                                    <span class="ticket-id">#{{this.id}}</span>
                                    <h4 class="ticket-subject">{{this.subject}}</h4>
                                </div>
                                <span class="ticket-status {{this.status}}">{{this.statusText}}</span>
                            </div>
                            <div class="ticket-content">
                                <p class="ticket-description">{{this.description}}</p>
                                {{#if this.response}}
                                <div class="ticket-response">
                                    <div class="response-header">
                                        <span class="response-icon">üí¨</span>
                                        <span class="response-label">–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</span>
                                    </div>
                                    <p>{{this.response}}</p>
                                </div>
                                {{/if}}
                            </div>
                            <div class="ticket-footer">                                
                                <div class="ticket-meta">
                                    <span class="ticket-date">
                                        <span class="meta-icon">üìÖ</span>
                                        –°–æ–∑–¥–∞–Ω–æ: {{formatDate this.date}}
                                    </span>
                                    {{#if this.closedDate}}
                                    <span class="ticket-closed-date">
                                        <span class="meta-icon">‚úì</span>
                                        –ó–∞–∫—Ä—ã—Ç–æ: {{formatDate this.closedDate}}
                                    </span>
                                    {{/if}}
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    <div class="support-chat" id="supportChat">
                        <div class="chat-messages" id="chatMessages">
                            {{#each chatMessages}}
                            <div class="message {{#if this.isSupport}}support{{else}}user{{/if}}">
                                <span class="message-time">{{formatTime this.time}}</span>
                                <p>{{this.text}}</p>
                            </div>
                            {{/each}}
                        </div>
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="profile" class="dashboard-section">
                <h2>–ú–æ–∏ –¥–∞–Ω–Ω—ã–µ</h2>
                <div class="profile-info">
                    <form id="profileForm" onsubmit="updateProfile(event)">
                        <div class="form-group">
                            <label>–§–ò–û</label>
                            <input type="text" name="fullName" value="{{user.full_name}}" readonly>
                        </div>
                        <div class="form-group">
                            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="tel" name="phone" value="{{user.phone}}" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email" value="{{user.email}}">
                        </div>
                        <div class="form-group">
                            <label>–ê–¥—Ä–µ—Å</label>
                            <input type="text" name="address" value="{{user.address}}" required>
                        </div>                        
                        <button type="submit" class="btn-submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </form>
                    <div class="password-change">
                        <h3>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
                        <form id="passwordForm" onsubmit="updatePassword(event)">
                            <div class="form-group">
                                <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" name="currentPassword" required>
                            </div>
                            <div class="form-group">
                                <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" name="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" name="confirmPassword" required>
                            </div>
                            <button type="submit" class="btn-submit">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                        </form>
                    </div>
                </div>
            </section>            
            <section id="documents" class="dashboard-section">
                <h2>–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
                <div class="documents-list">
                    <h3>–°—á–µ—Ç–∞</h3>
                    {{#each documents}}
                    {{#if (eq this.type "invoice")}}
                    <div class="document-item invoice" data-date="{{this.date}}">
                        <div class="document-info">
                            <span class="doc-name">{{this.name}}</span>
                            <span class="doc-date">{{formatDate this.date}}</span>
                            <span class="doc-status {{this.status}}">{{#if (eq this.status "paid")}}–û–ø–ª–∞—á–µ–Ω{{else}}–ù–µ –æ–ø–ª–∞—á–µ–Ω{{/if}}</span>
                        </div>
                        <div class="document-actions">                            
                            <button class="btn-preview" onclick="documentPreview.show('{{this.id}}', 'invoice')">
                                <span class="icon">üëÅ</span>
                                –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                            <button class="btn-download" onclick="documentPreview.download('{{this.id}}', 'invoice')">
                                <span class="icon">‚¨á</span>
                                –°–∫–∞—á–∞—Ç—å
                            </button>
                        </div>
                    </div>
                    {{/if}}
                    {{/each}}

                    <h3>–î–æ–≥–æ–≤–æ—Ä—ã</h3>
                    {{#each documents}}
                    {{#if (eq this.type "contract")}}
                    <div class="document-item contract" data-date="{{this.date}}">
                        <div class="document-info">
                            <span class="doc-name">{{this.name}}</span>
                            <span class="doc-date">{{formatDate this.date}}</span>
                        </div>
                        <div class="document-actions">                            
                            <button class="btn-preview" onclick="documentPreview.show('{{this.id}}', 'contract')">
                                <span class="icon">üëÅ</span>
                                –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                            <button class="btn-download" onclick="documentPreview.download('{{this.id}}', 'contract')">
                                <span class="icon">‚¨á</span>
                                –°–∫–∞—á–∞—Ç—å
                            </button>
                        </div>
                    </div>
                    {{/if}}
                    {{/each}}

                    <h3>–ê–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</h3>
                    {{#each documents}}
                    {{#if (eq this.type "act")}}
                    <div class="document-item act" data-date="{{this.date}}">
                        <div class="document-info">
                            <span class="doc-name">{{this.name}}</span>
                            <span class="doc-date">{{formatDate this.date}}</span>
                        </div>
                        <div class="document-actions">                            
                            <button class="btn-preview" onclick="documentPreview.show('{{this.id}}', 'act')">
                                <span class="icon">üëÅ</span>
                                –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                            <button class="btn-download" onclick="documentPreview.download('{{this.id}}', 'act')">
                                <span class="icon">‚¨á</span>
                                –°–∫–∞—á–∞—Ç—å
                            </button>
                        </div>
                    </div>
                    {{/if}}
                    {{/each}}
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="tariffModal" class="modal">
        <div class="modal-content">
            <h2>–í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞</h2>            
            <div class="tariffs-list">
                {{#each tariffs}}                
                <div class="tariff-option" {{#if (eq this.id ../user.tariff.id)}}data-active="true"{{/if}}>
                    <div class="tariff-header">
                        <h3>{{this.name}}</h3>
                    </div>
                    <div class="tariff-content">
                        <div class="speed">
                            {{this.speed}}<span>–ú–±–∏—Ç/—Å</span>
                        </div>
                        <div class="price">
                            {{this.price}}<span>‚ÇΩ/–º–µ—Å</span>
                        </div>
                        <div class="features">
                            <div class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span>–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span>–°—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</span>
                            </div>
                            <div class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span>–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7</span>
                            </div>
                        </div>
                        <button class="btn-tariff" onclick="changeTariff({{this.id}})">
                            <span class="btn-text">–í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ</span>
                            <span class="btn-icon">‚Üí</span>
                        </button>
                    </div>
                </div>
                {{/each}}
            </div>
            <button class="modal-close" onclick="closeTariffModal()">√ó</button>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h2>
            <form id="paymentForm" onsubmit="processPayment(event)">
                <div class="form-group">
                    <label>–°—É–º–º–∞</label>
                    <input type="number" name="amount" min="1" required>
                </div>
                <div class="payment-methods">
                    <label class="payment-method">
                        <input type="radio" name="method" value="card" checked>
                        <span>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</span>
                    </label>
                    <label class="payment-method">
                        <input type="radio" name="method" value="sbp">
                        <span>–°–ë–ü</span>
                    </label>
                </div>            
                <button type="submit" class="btn-submit">–û–ø–ª–∞—Ç–∏—Ç—å</button>
            </form>
            <button class="modal-close" onclick="closePaymentModal()">√ó</button>
        </div>
    </div>

    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <h2>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</h2>
            <form id="ticketForm" onsubmit="submitTicket(event)">
                <div class="form-group">
                    <label>–¢–µ–º–∞</label>
                    <select name="subject" required>
                        <option value="no_internet">–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞</option>
                        <option value="slow_speed">–ù–∏–∑–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å</option>
                        <option value="tech_support">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                        <option value="other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</label>
                    <textarea name="description" required></textarea>
                </div>
                <button type="submit" class="btn-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
            <button class="modal-close" onclick="closeTicketModal()">√ó</button>
        </div>
    </div>
</body>
</html>
